---
// Add any imports or frontend logic here
---

<link rel="stylesheet" href="../components/ImageUploader.css" />

<nav class="navbar">
  <div class="logo">
    <span>üêÆ</span> BrandMatch
  </div>
  <div class="nav-links">
    <a href="#" class="active">Home</a>
    <a href="#">About</a>
    <a href="#">Contact</a>
    <button class="upload-btn">Upload</button>
  </div>
  <div class="profile">
    <img src="/profile.jpg" alt="Profile" />
  </div>
</nav>

<main class="container">
  <h1>Upload a cattle brand</h1>

  <div class="main-content">
    <div class="upload-section">
      <div class="preview-area">
        <img src="/default-brand.jpg" alt="Brand preview" id="preview-image" class="preview-image" />
      </div>
      
      <div class="upload-form-section">
        <h2>Upload your brand image</h2>
        <p>Upload a clear image of your cattle brand to find similar matches in our database.</p>
        
        <form id="upload-form">
          <div class="upload-controls">
            <button type="button" class="upload-btn-secondary" onclick="document.getElementById('image-input').click()">
              Upload...
            </button>
            <input type="file" id="image-input" name="image" accept="image/*" hidden />
          </div>

          <div class="matches-control">
            <label for="n-results">Number of Matches</label>
            <input type="number" id="n-results" name="n-results" min="1" max="10" value="5" />
          </div>

          <button type="submit" class="find-matches-btn">Find Matches</button>
        </form>
      </div>
    </div>

    <section class="results-section" id="results-container">
      <h2>Results</h2>
      <div id="results-list" class="results-grid">
        <!-- Results will be inserted here -->
      </div>
    </section>
  </div>
</main>

<script type="module">
  const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:8000";

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('upload-form');
    const imageInput = document.getElementById('image-input');
    const previewImage = document.getElementById('preview-image');
    const resultsList = document.getElementById('results-list');
    const nResultsInput = document.getElementById('n-results');

    imageInput?.addEventListener('change', () => {
      if (imageInput?.files?.[0]) {
        const file = imageInput.files[0];
        previewImage.src = URL.createObjectURL(file);
      }
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!imageInput?.files?.[0]) {
        alert('Please select an image first');
        return;
      }

      const formData = new FormData();
      formData.append('file', imageInput.files[0]);

      const n_results = parseInt(nResultsInput?.value || '5');
      resultsList.innerHTML = '<div class="result-card">‚è≥ Searching...</div>';

      try {
        const response = await fetch(`${API_URL}/search?n_results=${n_results}`, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) throw new Error('Server error');

        const data = await response.json();
        resultsList.innerHTML = '';

        if (data?.matches && data.matches.length > 0) {
          data.matches.forEach((match) => {
            const similarityPercent = ((1 - match.distance) * 100).toFixed(1);
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
              <img src="${API_URL}${match.imageUrl}" 
                   alt="${match.filename}" 
                   loading="lazy" />
              <div class="result-info">
                <div>${match.filename}</div>
                <div class="similarity-score">Similarity: ${similarityPercent}%</div>
              </div>
            `;
            resultsList.appendChild(resultCard);
          });
        } else {
          resultsList.innerHTML = '<div class="result-card">‚ùå No matches found</div>';
        }
      } catch (err) {
        resultsList.innerHTML = `<div class="result-card">‚ùå Error: ${err instanceof Error ? err.message : 'Unknown error'}</div>`;
      }
    });
  });
</script>
